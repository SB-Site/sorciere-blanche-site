<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmation d'Achat - Les Éditions de la Sorcière Blanche</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Cinzel&family=Montserrat&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/base.css">
  <link rel="stylesheet" href="/index.css">
  <link rel="stylesheet" href="/confirmation-achat.css">
  <link rel="stylesheet" href="/protection.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/script.js"></script>
</head>
<body>
  <div class="cookie-banner" id="cookieBanner">
    <p>Nous utilisons des cookies pour améliorer votre expérience. <a href="/politique-cookies.html">En savoir plus</a>.</p>
    <button onclick="acceptCookies()">Accepter</button>
  </div>
  <div class="announcement-bar">
    <p><strong>Lancement réussi ! Explorez nos ouvrages enchantés en vente dès maintenant. ✨</strong> <a href="/boutique.html" class="announcement-button">Voir la boutique</a></p>
  </div>
  <header>
    <div class="header-content">
      <a href="/index.html" class="logo-link">
        <img src="/images/sb_logo_fr.jpg" alt="Sorcière Blanche Éditions Logo" class="logo">
        <div class="header-title">
          <span>Les Éditions de la</span>
          <span>Sorcière Blanche</span>
        </div>
      </a>
      <nav>
        <ul>
          <li><a href="/index.html">Accueil</a></li>
          <li><a href="/boutique.html">Boutique</a></li>
          <li><a href="/a-propos.html">À Propos</a></li>
          <li><a href="/je-soutiens.html">Je Soutiens</a></li>
          <li><a href="/contact.html">Contact</a></li>
          <li><a href="/blog.html">Blog</a></li>
          <li><a href="/creer-compte.html" class="account-icon"><img src="/images/sb_sorciere.png" alt="Rejoindre / Ouvrir Mon Portail" class="sorciere-icon" title="Rejoindre / Ouvrir Mon Portail"></a></li>
          <li><a href="/panier.html" class="cart-icon"><img src="/images/icon_basket.png" alt="Panier" class="cart-icon-img" title="Voir le panier"></a></li>
          <li class="lang-switcher">
            <img src="/images/icon_globe.png" alt="Globe" class="globe-icon">
            <a href="/confirmation-achat.html" class="lang-fr active">FR</a>
            <a href="/en/confirmation-achat.html" class="lang-en">EN</a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <main>
    <section class="confirmation-content">
      <h1>Merci pour votre achat enchanté ! ✨</h1>
      <img src="/images/icon_star.png" alt="Star Icon" class="confirmation-icon">
      <div class="confirmation-details">
        <p>Votre commande a été validée. Vous recevrez un email de confirmation avec le récapitulatif et le lien de téléchargement sécurisé pour l'eBook <strong>Lazare Donatien L'Intégrale</strong> dans les prochaines minutes.</p>
        <p>Si vous n'avez pas reçu l'email, vérifiez vos spams ou contactez-nous via <a href="/contact.html">notre page contact</a>.</p>
        <p id="order-id-section" style="display: none;">ID de commande : <span id="order-id"></span></p>
        <div class="order-recap">
          <h3>Récapitulatif de votre commande</h3>
          <ul id="order-list">
            <!-- Rempli par JS -->
          </ul>
          <p><strong>Total : <span id="order-total">0,00 €</span></strong></p>
        </div>
        <div class="next-steps">
          <h3>Prochaines étapes</h3>
          <ul>
            <li>Vérifiez votre email pour la confirmation et le lien de téléchargement (valide 7 jours).</li>
            <li>Pour les produits physiques, suivez le numéro de suivi dans votre email.</li>
            <li>Des questions ? <a href="/contact.html">Contactez-nous</a>.</li>
          </ul>
        </div>
      </div>
      <a href="/boutique.html" class="continue-shopping">Continuer mes achats</a>
    </section>
  </main>
  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <a href="/index.html">
          <img src="/images/sb_logo_fr.jpg" alt="Sorcière Blanche Éditions Logo" class="logo">
          <div class="footer-title">
            <span>Les Éditions de la</span>
            <span>Sorcière Blanche</span>
          </div>
        </a>
        <p>Maison d'édition bilingue spécialisée dans les livres ésotériques, fantastiques et mystiques. Découvrez un univers de magie et de mystère à travers nos publications uniques.</p>
      </div>
      <div class="footer-info">
        <h3>Informations</h3>
        <ul>
          <li><a href="/conditions-generales.html">Conditions Générales</a></li>
          <li><a href="/politique-confidentailite.html">Politique de Confidentialité</a></li>
          <li><a href="/livraison-retours.html">Livraison et Retours</a></li>
          <li><a href="/politique-cookies.html">Politique de Cookies</a></li>
        </ul>
      </div>
      <div class="footer-menu">
        <h3>Menu</h3>
        <ul>
          <li><a href="/index.html">Accueil</a></li>
          <li><a href="/boutique.html">Boutique</a></li>
          <li><a href="/a-propos.html">À Propos</a></li>
          <li><a href="/je-soutiens.html">Je Soutiens</a></li>
          <li><a href="/contact.html">Contact</a></li>
          <li><a href="/blog.html">Blog</a></li>
        </ul>
      </div>
      <div class="footer-social">
        <h3>Suivez-nous</h3>
        <ul>
          <li><a href="https://x.com/WhiteWitchEdits"><img src="/images/icon_x.png" alt="X" class="social-icon"></a></li>
          <li><a href="https://www.facebook.com/sorciereblancheeditions/"><img src="/images/icon_facebook.png" alt="Facebook" class="social-icon"></a></li>
          <li><a href="https://www.instagram.com/sorciereblancheeditions/"><img src="/images/icon_instagram.png" alt="Instagram" class="social-icon"></a></li>
          <li><a href="https://fr.pinterest.com/Leseditionsdelasorciereblanche/"><img src="/images/icon_pinterest.png" alt="Pinterest" class="social-icon"></a></li>
          <li><a href="https://www.youtube.com/@Sorci%C3%A8reBlancheEditions"><img src="/images/icon_youtube.png" alt="YouTube" class="social-icon"></a></li>
          <li><a href="https://www.tiktok.com/@sorciereblancheed"><img src="/images/icon_tiktok.png" alt="TikTok" class="social-icon"></a></li>
        </ul>
      </div>
    </div>
    <p class="copyright">© 2025 Éditions de la Sorcière Blanche. Tous droits réservés. Aucune reproduction d'images et/ou de texte autorisée sans autorisation expresse.</p>
  </footer>
  <script src="/protection.js"></script>
  <script>
    // Init Supabase client (renommé 'client' pour éviter conflit global 'supabase')
    const supabaseUrl = 'https://cskhhttnmjfmieqkayzg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNza2hodHRubWpmbWllcWtheXpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTk1NDgsImV4cCI6MjA2OTg5NTU0OH0.or26KhHzKJ7oPYu0tQrXLIMwpBxZmHqGwC5rfGKrADI';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    document.addEventListener('DOMContentLoaded', async () => {
      // Récup order ID de l'URL (de PayPal redirect sur panier.html)
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('order');
      if (orderId) {
        document.getElementById('order-id').textContent = orderId;
        document.getElementById('order-id-section').style.display = 'block';
        console.log('Order ID loaded:', orderId); // Debug
      }
      // Lit 'lastOrderCart' pour récap (sauvegardé de panier.html)
      const lastOrderCart = JSON.parse(localStorage.getItem('lastOrderCart') || '[]');
      console.log('LastOrderCart from localStorage:', lastOrderCart); // Debug : Vérif vide ?
      const orderList = document.getElementById('order-list');
      const orderTotal = document.getElementById('order-total');
      let total = 0;
      if (lastOrderCart.length > 0) {
        orderList.innerHTML = lastOrderCart.map(item => {
          const lineTotal = item.price * item.quantity;
          total += lineTotal;
          return `<li>${item.name} x${item.quantity} - ${lineTotal.toFixed(2)} €</li>`;
        }).join('');
      } else {
        // Fallback pour tests Sandbox (si localStorage vide : assume Lazare eBook standard)
        orderList.innerHTML = '<li>Lazare Donatien L\'Intégrale eBook x1 - 5.99 €</li>';
        total = 5.99;
        console.warn('lastOrderCart vide - fallback récap Lazare eBook');
      }
      orderTotal.textContent = total.toFixed(2) + ' €';
      console.log('Récap total calculé:', total); // Debug
      // Efface la sauvegarde après usage (propreté)
      localStorage.removeItem('lastOrderCart');
      // Envoi email confirmation (avec .catch full pour debug)
      fetch('/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          to: 'contact@sorciereblancheeditions.com', // TODO: Acheteur email depuis PayPal/session
          subject: 'Confirmation d\'achat - Lazare eBook',
          body: `Merci pour votre achat ! Order ID: ${orderId || 'N/A'}, Total: ${total.toFixed(2)} €. Lien téléchargement: https://sorciereblancheeditions.com/EBooks/Lazare-integrale.pdf (valide 7 jours).`
        })
      }).then(response => {
        if (response.ok) {
          console.log('Email confirmation envoyé OK');
        } else {
          console.error('Email confirmation fail:', response.status, response.statusText);
        }
      }).catch(err => console.error('Fetch email error:', err));

      // Bonus : Log order en DB si user logué (après recap/email)
      const { data: { session } } = await client.auth.getSession();
      console.log('Supabase session:', session ? 'Logué' : 'Non logué'); // Debug
      if (session?.user && orderId && total > 0) {
        try {
          const response = await fetch('/api/log-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: session.user.id,
              orderId: orderId,
              total: total
            })
          });
          if (response.ok) {
            console.log('Order loggé en DB OK');
          } else {
            console.warn('Log order failed (non-blocking):', response.status);
          }
        } catch (err) {
          console.error('Fetch log-order error:', err);
        }
      } else {
        console.log('Skip DB log (no session/order/total)');
      }
    });
  </script>
</body>
</html>