<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmation d'Achat - Les √âditions de la Sorci√®re Blanche</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Cinzel&family=Montserrat&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/base.css">
  <link rel="stylesheet" href="/index.css">
  <link rel="stylesheet" href="/confirmation-paiement.css">
  <link rel="stylesheet" href="/protection.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="/script.js"></script>
  <style>
    .confirmation-content {
      max-width: 600px;
      margin: 50px auto;
      padding: 50px;
      text-align: center;
      background: #FFF8DC; /* Cream background */
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .confirmation-content:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 25px rgba(212, 175, 55, 0.4);
    }
    .confirmation-icon {
      width: 80px;
      height: 80px;
      margin: 1rem auto;
      filter: drop-shadow(0 2px 10px rgba(255, 255, 255, 0.5));
      animation: glow 2s infinite alternate;
    }
    @keyframes glow {
      from { filter: drop-shadow(0 2px 10px rgba(80, 200, 120, 0.5)); }
      to { filter: drop-shadow(0 2px 15px rgba(212, 175, 55, 0.8)); }
    }
    .confirmation-details p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--violet, #8A2BE2);
      margin: 1rem 0;
    }
    #order-id-section {
      font-weight: bold;
      color: var(--emeraude, #50C878);
    }
    .order-recap h3 {
      color: var(--cuivre, #D4AF37);
      border-bottom: 2px solid var(--emeraude, #50C878);
      padding-bottom: 0.5rem;
    }
    .order-recap ul {
      list-style: none;
      padding: 0;
      text-align: left;
    }
    .order-recap li {
      margin: 0.5rem 0;
      position: relative;
      padding-left: 1.5rem;
      color: var(--violet, #8A2BE2);
    }
    .order-recap li::before {
      content: 'üìñ';
      position: absolute;
      left: 0;
    }
    .order-recap p strong {
      color: var(--emeraude, #50C878);
    }
    .next-steps h3 {
      color: var(--cuivre, #D4AF37);
      border-bottom: 2px solid var(--emeraude, #50C878);
      padding-bottom: 0.5rem;
    }
    .next-steps ul {
      text-align: left;
      list-style: none;
      padding: 0;
    }
    .next-steps li {
      margin: 0.5rem 0;
      position: relative;
      padding-left: 1.5rem;
    }
    .next-steps li::before {
      content: '‚ú®';
      position: absolute;
      left: 0;
    }
    .next-steps li a {
      color: var(--violet, #8A2BE2);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .next-steps li a:hover {
      color: var(--cuivre, #D4AF37);
    }
    .continue-shopping {
      display: inline-block;
      background: var(--violet, #8A2BE2);
      color: white;
      padding: 1rem 2rem;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 2rem;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .continue-shopping:hover {
      background: var(--cuivre, #D4AF37);
      transform: translateY(-3px);
    }
  </style>
</head>
<body>
  <div class="cookie-banner" id="cookieBanner">
    <p>Nous utilisons des cookies pour am√©liorer votre exp√©rience. <a href="/politique-cookies.html">En savoir plus</a>.</p>
    <button onclick="acceptCookies()">Accepter</button>
  </div>
  <div class="announcement-bar">
    <p><strong>Lancement r√©ussi ! Explorez nos ouvrages enchant√©s en vente d√®s maintenant. ‚ú®</strong> <a href="/boutique.html" class="announcement-button">Voir la boutique</a></p>
  </div>
  <header>
    <div class="header-content">
      <a href="/index.html" class="logo-link">
        <img src="/images/sb_logo_fr.jpg" alt="Sorci√®re Blanche √âditions Logo" class="logo">
        <div class="header-title">
          <span>Les √âditions de la</span>
          <span>Sorci√®re Blanche</span>
        </div>
      </a>
      <nav>
        <ul>
          <li><a href="/index.html">Accueil</a></li>
          <li><a href="/boutique.html">Boutique</a></li>
          <li><a href="/a-propos.html">√Ä Propos</a></li>
          <li><a href="/je-soutiens.html">Je Soutiens</a></li>
          <li><a href="/contact.html">Contact</a></li>
          <li><a href="/blog.html">Blog</a></li>
          <li><a href="/creer-compte.html" class="account-icon"><img src="/images/sb_sorciere.png" alt="Rejoindre / Ouvrir Mon Portail" class="sorciere-icon" title="Rejoindre / Ouvrir Mon Portail"></a></li>
          <li><a href="/panier.html" class="cart-icon"><img src="/images/icon_basket.png" alt="Panier" class="cart-icon-img" title="Voir le panier"></a></li>
          <li class="lang-switcher">
            <img src="/images/icon_globe.png" alt="Globe" class="globe-icon">
            <a href="/confirmation-paiement.html" class="lang-fr active">FR</a>
            <a href="/en/confirmation-paiement.html" class="lang-en">EN</a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <main>
    <section class="confirmation-content" aria-labelledby="confirmation-title">
      <h1 id="confirmation-title">Merci pour votre achat enchant√© ! ‚ú®</h1>
      <img src="/images/icon_star.png" alt="Ic√¥ne √©toile magique" class="confirmation-icon">
      <div class="confirmation-details">
        <p>Votre commande a √©t√© valid√©e. Vous recevrez un email de confirmation avec le r√©capitulatif et le lien de t√©l√©chargement s√©curis√© pour vos produits num√©riques dans les prochaines minutes.</p>
        <p>Si vous n'avez pas re√ßu l'email, v√©rifiez vos spams ou contactez-nous via <a href="/contact.html">notre page contact</a>.</p>
        <p id="order-id-section" style="display: none;">ID de commande : <span id="order-id"></span></p>
        <div class="order-recap">
          <h3>R√©capitulatif de votre commande</h3>
          <ul id="order-list" aria-label="D√©tails de la commande">
            <!-- Rempli par JS -->
          </ul>
          <p><strong>Total : <span id="order-total">0,00 ‚Ç¨</span></strong></p>
        </div>
        <div class="next-steps">
          <h3>Prochaines √©tapes</h3>
          <ul aria-label="√âtapes suivantes apr√®s achat">
            <li>V√©rifiez votre email pour la confirmation et les liens de t√©l√©chargement (valides 7 jours).</li>
            <li>Pour les produits physiques, suivez le num√©ro de suivi dans votre email.</li>
            <li>Explorez notre <a href="/boutique.html">Boutique</a> pour plus de magie.</li>
            <li>Des questions ? <a href="/contact.html">Contactez-nous</a>.</li>
          </ul>
        </div>
      </div>
      <a href="/boutique.html" class="continue-shopping" aria-label="Continuer les achats">Continuer mes achats</a>
    </section>
  </main>
  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <a href="/index.html">
          <img src="/images/sb_logo_fr.jpg" alt="Sorci√®re Blanche √âditions Logo" class="logo">
          <div class="footer-title">
            <span>Les √âditions de la</span>
            <span>Sorci√®re Blanche</span>
          </div>
        </a>
        <p>Maison d'√©dition bilingue sp√©cialis√©e dans les livres √©sot√©riques, fantastiques et mystiques. D√©couvrez un univers de magie et de myst√®re √† travers nos publications uniques.</p>
      </div>
      <div class="footer-info">
        <h3>Informations</h3>
        <ul>
          <li><a href="/conditions-generales.html">Conditions G√©n√©rales</a></li>
          <li><a href="/politique-confidentialite.html">Politique de Confidentialit√©</a></li>
          <li><a href="/livraison-retours.html">Livraison et Retours</a></li>
          <li><a href="/politique-cookies.html">Politique de Cookies</a></li>
          <li><a href="/mentions-legales.html">Mentions L√©gales</a></li>
        </ul>
      </div>
      <div class="footer-menu">
        <h3>Menu</h3>
        <ul>
          <li><a href="/index.html">Accueil</a></li>
          <li><a href="/boutique.html">Boutique</a></li>
          <li><a href="/a-propos.html">√Ä Propos</a></li>
          <li><a href="/je-soutiens.html">Je Soutiens</a></li>
          <li><a href="/contact.html">Contact</a></li>
          <li><a href="/blog.html">Blog</a></li>
        </ul>
      </div>
      <div class="footer-social">
        <h3>Suivez-nous</h3>
        <ul aria-label="R√©seaux sociaux">
          <li><a href="https://x.com/WhiteWitchEdits"><img src="/images/icon_x.png" alt="X (Twitter)" class="social-icon"></a></li>
          <li><a href="https://www.facebook.com/sorciereblancheeditions/"><img src="/images/icon_facebook.png" alt="Facebook" class="social-icon"></a></li>
          <li><a href="https://www.instagram.com/sorciereblancheeditions/"><img src="/images/icon_instagram.png" alt="Instagram" class="social-icon"></a></li>
          <li><a href="https://fr.pinterest.com/Leseditionsdelasorciereblanche/"><img src="/images/icon_pinterest.png" alt="Pinterest" class="social-icon"></a></li>
          <li><a href="https://www.youtube.com/@Sorci%C3%A8reBlancheEditions"><img src="/images/icon_youtube.png" alt="YouTube" class="social-icon"></a></li>
          <li><a href="https://www.tiktok.com/@sorciereblancheed"><img src="/images/icon_tiktok.png" alt="TikTok" class="social-icon"></a></li>
        </ul>
      </div>
    </div>
    <p class="copyright">¬© 2025 √âditions de la Sorci√®re Blanche. Tous droits r√©serv√©s. Aucune reproduction d‚Äôimages et/ou de texte autoris√©e sans autorisation expresse.</p>
  </footer>
  <script src="/protection.js"></script>
  <script>
    // Init Supabase client (renomm√© 'client' pour √©viter conflit global 'supabase')
    const supabaseUrl = 'https://cskhhttnmjfmieqkayzg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNza2hodHRubWpmbWllcWtheXpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTk1NDgsImV4cCI6MjA2OTg5NTU0OH0.or26KhHzKJ7oPYu0tQrXLIMwpBxZmHqGwC5rfGKrADI';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    document.addEventListener('DOMContentLoaded', async () => {
      // R√©cup order ID de l'URL (de PayPal redirect sur panier.html)
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('order');
      if (orderId) {
        document.getElementById('order-id').textContent = orderId;
        document.getElementById('order-id-section').style.display = 'block';
        console.log('Order ID loaded:', orderId);
      } else {
        console.warn('Pas d\'orderId dans URL ‚Äì fallback test');
      }

      // Lit 'lastOrderCart' pour r√©cap (sauvegard√© de panier.html)
      const lastOrderCart = JSON.parse(localStorage.getItem('lastOrderCart') || '[]');
      console.log('LastOrderCart from localStorage:', lastOrderCart);

      const orderList = document.getElementById('order-list');
      const orderTotal = document.getElementById('order-total');
      let total = 0;

      if (lastOrderCart.length > 0) {
        orderList.innerHTML = lastOrderCart.map(item => {
          const lineTotal = item.price * item.quantity;
          total += lineTotal;
          return `<li>${item.name} x${item.quantity} - ${lineTotal.toFixed(2)} ‚Ç¨</li>`;
        }).join('');
      } else {
        // Fallback pour tests Sandbox (assume produit standard si vide)
        orderList.innerHTML = '<li>Lazare Donatien L\'Int√©grale eBook x1 - 5.99 ‚Ç¨</li>';
        total = 5.99;
        console.warn('lastOrderCart vide - fallback r√©cap Lazare eBook');
      }

      orderTotal.textContent = total.toFixed(2) + ' ‚Ç¨';
      console.log('R√©cap total calcul√©:', total);

      // Efface la sauvegarde apr√®s usage
      localStorage.removeItem('lastOrderCart');

      // Envoi email confirmation via EmailJS (client-side)
      emailjs.init("TON_USER_ID_EMAILJS"); // ‚Üê Remplace par ton User ID EmailJS

      const session = await client.auth.getSession();
      const buyerEmail = session?.data?.session?.user?.email || 'contact@sorciereblancheeditions.com'; // Fallback si non logu√©

      emailjs.send("TON_SERVICE_ID", "TON_TEMPLATE_ID", {
        name: session?.data?.session?.user?.user_metadata?.username || 'Cher Client',
        email: buyerEmail,
        orderId: orderId || 'N/A',
        total: total.toFixed(2),
        items: lastOrderCart.map(item => `${item.name} x${item.quantity}`).join(', ') || 'Lazare Donatien L\'Int√©grale eBook x1',
        downloadLink: 'https://sorciereblancheeditions.com/EBooks/Lazare-integrale.pdf' // Adapte si dynamique
      }).then(() => {
        console.log('Email de confirmation envoy√© avec succ√®s !');
      }).catch(err => {
        console.error('Erreur envoi email:', err);
      });

      // Bonus : Log order en DB si user logu√©
      if (session?.data?.session?.user && orderId && total > 0) {
        try {
          const { error } = await client
            .from('orders') // Suppose une table 'orders' dans Supabase
            .insert([{ user_id: session.data.session.user.id, order_id: orderId, total: total }]);
          if (error) throw error;
          console.log('Order logg√© en DB OK');
        } catch (err) {
          console.error('Erreur log DB:', err);
        }
      } else {
        console.log('Skip DB log (no session/order/total)');
      }
    });
  </script>
</body>
</html>